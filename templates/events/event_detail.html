{% extends 'events/base.html' %}
{% load static %}
{% load group_tags %}

{% block styles %}
<link rel="stylesheet" href="{% static 'events/css/event_detail.css' %}">
{% endblock %}

{% block title %}{{ event.name }} | PartyFinder{% endblock %}

{% block content %}
<div class="event-detail-container">
  <!-- Back Button -->
  <div class="back-navigation">
    <a href="{% url 'events' %}" class="btn-back">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Events
    </a>
  </div>

  <!-- Event Header -->
  <div class="event-header">
    <div class="event-header-content">
      <h1 class="event-title">{{ event.name }}</h1>
      
      <div class="event-meta">
        <div class="meta-item">
          <svg class="meta-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          <span>{{ event.city }}, {{ event.country }}</span>
        </div>
        
        <div class="meta-item">
          <svg class="meta-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <span>{{ event.date }}</span>
        </div>
        
        <div class="meta-item">
          <svg class="meta-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <span>Organized by {{ event.created_by.username }}</span>
        </div>
      </div>
    </div>
    
    <div class="event-availability">
      <div class="availability-badge {% if event.available_tickets > 0 %}available{% else %}sold-out{% endif %}">
        <span class="badge-icon">ðŸŽ«</span>
        <div class="badge-text">
          <span class="badge-label">Available</span>
          <span class="badge-value" id="availableTickets">{{ event.available_tickets }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="event-content-grid">
    <!-- Left Column: Flyer and Gallery -->
    <div class="event-media-section">
      {% if event.flyer %}
        <div class="event-flyer">
          <img src="{{ event.flyer.url }}" alt="Flyer of {{ event.name }}">
        </div>
      {% endif %}

      {% if event.images.all or event.videos.all %}
        <div class="event-gallery-section">
          <h3 class="section-title">Gallery</h3>
          <div class="gallery">
            {% for image in event.images.all %}
              {% if image.image_url %}
                <div class="gallery-item">
                  <img src="{{ image.image_url.url }}" alt="Image of {{ event.name }}">
                </div>
              {% endif %}
            {% endfor %}

            {% for video in event.videos.all %}
              {% if video.video_url %}
                <div class="gallery-item">
                  <video controls>
                    <source src="{{ video.video_url.url }}" type="video/mp4">
                  </video>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Right Column: Description and Purchase -->
    <div class="event-info-section">
      <!-- Description Card -->
      <div class="info-card description-card">
        <h3 class="card-title">About this Event</h3>
        <p class="event-description">{{ event.description }}</p>
      </div>

      <!-- Purchase Card -->
      <div class="info-card purchase-card">
        <h3 class="card-title">Get Your Tickets</h3>
        
        <form id="purchaseForm" 
              method="post" 
              action="{% url 'buy_tickets' event.id %}"
              data-event-id="{{ event.id }}"
              data-max-per-user="{{ event.max_tickets_per_user }}"
              data-available-tickets="{{ event.available_tickets }}"
              data-already-bought="{{ already_bought|default:0 }}"
              {% if not user.is_authenticated %}data-redirect-login="{% url 'login' %}?next={{ request.get_full_path }}"{% endif %}>
          
          {% csrf_token %}

          <div class="purchase-form">
            <div class="form-group">
              <label class="form-label">Select Sector</label>
              <select id="sector" name="sector_id" class="form-select" required>
                <option value="" disabled selected>Choose a sector...</option>
                {% with sector_list=sectors|default:event.sectors.all %}
                  {% for s in sector_list %}
                    <option value="{{ s.id }}" 
                            data-available="{{ s.sector_inventory }}" 
                            data-price="{{ s.sector_price }}">
                      {{ s.sector_name }} - ${{ s.sector_price }} ({{ s.sector_inventory }} available)
                    </option>
                  {% endfor %}
                {% endwith %}
              </select>
              <div id="sectorPrice" class="form-hint"></div>
            </div>

            <div class="form-group">
              <label class="form-label">Quantity</label>
              <div class="quantity-control">
                <button type="button" class="qty-btn" id="decreaseQty">âˆ’</button>
                <input type="number" id="quantity" name="quantity" min="1" 
                       max="{{ event.max_tickets_per_user }}" class="form-control qty-input" value="1" required>
                <button type="button" class="qty-btn" id="increaseQty">+</button>
              </div>
              <div class="form-hint">Maximum {{ event.max_tickets_per_user }} per purchase</div>
            </div>

            <div class="purchase-summary">
              <div class="summary-row">
                <span>Subtotal</span>
                <span id="subtotal" class="summary-value">$0.00</span>
              </div>
              <div class="summary-row total">
                <span>Total</span>
                <span id="total" class="summary-value">$0.00</span>
              </div>
            </div>

            <button type="submit" id="buyBtn" class="btn-purchase">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
              </svg>
              Purchase Tickets
            </button>
          </div>
        </form>
      </div>

      <!-- Organizer Actions -->
      {% if user.is_authenticated and user == event.created_by and user|has_group:'Event_Organizer' %}
        <div class="info-card organizer-card">
          <h3 class="card-title">Organizer Actions</h3>
          <a href="{% url 'manage_tickets' event.id %}" class="btn-manage">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Manage Tickets by Sector
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMACIÃ“N -->
<div class="modal fade" id="confirmPurchaseModal" tabindex="-1" aria-labelledby="confirmPurchaseLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmPurchaseLabel">Confirm Purchase</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="confirmText"><span id="confirmQuantity"></span></p>
        <p class="text-danger" id="confirmWarning"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="modalConfirm">Confirm Purchase</button>
      </div>
    </div>
  </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackModalLabel">Notice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="feedbackModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Processing Overlay -->
<div id="processingOverlay" style="display: none;">
  <div class="processing-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Processing...</span>
    </div>
    <p class="mt-3">Processing your purchase...</p>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'events/js/ticket_purchase.js' %}"></script>
{% endblock %}

